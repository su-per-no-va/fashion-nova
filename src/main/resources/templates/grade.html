<!DOCTYPE html>
<html lang="en">
<head>
	<title>My Grade</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->	
	<link rel="icon" type="image/png" href="../images/icons/favicon.png"/>
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../vendor/bootstrap/css/bootstrap.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../fonts/iconic/css/material-design-iconic-font.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../fonts/linearicons-v1.0.0/icon-font.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../vendor/animate/animate.css">
<!--===============================================================================================-->	
	<link rel="stylesheet" type="text/css" href="../vendor/css-hamburgers/hamburgers.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../vendor/animsition/css/animsition.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../vendor/select2/select2.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../vendor/perfect-scrollbar/perfect-scrollbar.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../css/util.css">
	<link rel="stylesheet" type="text/css" href="../css/main.css">
	<link rel="stylesheet" type="text/css" href="/css/grade.css">
<!--===============================================================================================-->
</head>
<body class="animsition">

<!-- Header -->
<header>
	<!-- Header desktop -->
	<div class="container-menu-desktop">
		<!-- Topbar -->
		<div class="top-bar">
			<div class="content-topbar flex-sb-m h-full container">
				<div class="left-top-bar">
					패셔니스타들을 위한, 패셔니스타들에 의한 패션노바
				</div>

				<div class="right-top-bar flex-w h-full">
					<a href="login.html" id="auth-btn" class="flex-c-m trans-04 p-lr-25">
						Login
					</a>

					<a href="question.html" class="flex-c-m trans-04 p-lr-25">
						Q&A
					</a>

					<a href="my-page.html" class="flex-c-m trans-04 p-lr-25">
						My Page
					</a>
				</div>
			</div>
		</div>

		<div class="wrap-menu-desktop">
			<nav class="limiter-menu-desktop container">

				<!-- Logo desktop -->
				<a href="index.html" class="logo">
					<img src="../images/icons/logo-01.png" alt="IMG-LOGO">
				</a>

				<!-- Menu desktop -->
				<div class="menu-desktop">
					<ul class="main-menu">
						<li>
							<a href="about.html">About</a>
						</li>

						<li class="label1" data-label1="hot">
							<a href="product.html">Shop</a>
						</li>

						<li>
							<a href="contact.html">Contact</a>
						</li>
					</ul>
				</div>

				<!-- Icon header -->
				<div class="wrap-icon-header flex-w flex-r-m">
					<a id="cart-icon" href="shoping-cart.html" class="icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti js-show-cart" data-notify="">
						<i class="zmdi zmdi-shopping-cart"></i>
					</a>

					<a id="wish-icon" href="wish-list.html" class="dis-block icon-header-item cl2 hov-cl1 trans-04 p-l-22 p-r-11 icon-header-noti" data-notify="">
						<i class="zmdi zmdi-favorite-outline"></i>
					</a>
				</div>
			</nav>
		</div>
	</div>
</header>

<!-- Title page -->
<section class="bg-img1 txt-center p-lr-15 p-tb-92" style="background-image: url('../images/bg-01.jpg');">
	<h2 class="ltext-105 cl0 txt-center">
		My Grade
	</h2>
</section>

<!-- breadcrumb -->
<div class="container">
	<div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
		<a href="index.html" class="stext-109 cl8 hov-cl1 trans-04">
			Home
			<i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
		</a>

		<a href="my-page.html" class="stext-109 cl8 hov-cl1 trans-04">
			My Page
			<i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
		</a>

		<span class="stext-109 cl4">
				My Grade
			</span>
	</div>
</div>

<!-- My Grade page -->
<section class="bg0 p-t-104 p-b-116">
	<div class="container">
		<div class="size-300 bor10 p-lr-70 p-t-55 p-b-70 p-lr-15-lg w-full-md">
			<form>
				<div class="content">
					<div class="grade-info">
						<img id="grade-icon" src="../images/icons/bronze.png" alt="IMG-GRADE">
						<h4 id="grade-name" class="mtext-105 cl2 txt-center p-b-30">
							브론즈
						</h4>
						<p id="current-month-spent">00월 결제금액: 1000원</p>
						<p id="total-spent">00월 결제금액: 0</p>
						<p id="next-month-grade">다음 달 예상 등급: 골드</p>
					</div>
					<div class="grade-benefits">
						<div class="benefit">
							<img src="../images/icons/bronze.png" alt="IMG-GRADE">
							<h3>브론즈</h3>
							<p>한달 기준 구매금액 100만원 이하</p>
						</div>
						<div class="benefit">
							<img src="../images/icons/silver.png" alt="IMG-GRADE">
							<h3>실버</h3>
							<p>한달 기준 구매금액 100만원 초과</p>
						</div>
						<div class="benefit">
							<img src="../images/icons/gold.png" alt="IMG-GRADE">
							<h3>골드</h3>
							<p>한달 기준 구매금액 200만원 초과</p>
						</div>
					</div>
					<div class="benefits-details">
						<h3>브론즈 혜택</h3>
						<p>3% 할인쿠폰 지급(지급일로부터 30일동안 사용 가능)</p>
						<p>구매시 1% 적립</p>
						<br>
						<h3>실버 혜택</h3>
						<p>5% 할인쿠폰 지급(지급일로부터 30일동안 사용 가능)</p>
						<p>구매시 3% 적립</p>
						<br>
						<h3>골드 혜택</h3>
						<p>10% 할인쿠폰 지급(지급일로부터 30일동안 사용 가능)</p>
						<p>구매시 5% 적립</p>
					</div>
				</div>
			</form>
		</div>
	</div>
</section>

	<!-- Footer -->
	<footer class="bg3 p-t-75 p-b-32">
		<div class="container">
			<div class="row">

				<div class="col-sm-6 col-lg-3 p-b-50">
					<h4 class="stext-301 cl0 p-b-30">
						FEEDBACK
					</h4>

					<p class="stext-107 cl7 size-201">
						언제나 고객님들의 피드백을 반영하여 항상 더욱 발전하는 패션 노바가 되겠습니다.
					</p>
				</div>

				<div class="p-t-40">
					<div class="flex-c-m flex-w p-b-18">
						<a href="#" class="m-all-1">
							<img src="../images/icons/icon-pay-01.png" alt="ICON-PAY">
						</a>
					</div>

					<p class="stext-107 cl6 txt-center">
						<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
						이 홈페이지는 상업적으로 이용되지 않습니다.
						<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->

					</p>
				</div>
			</div>
		</div>
	</footer>


	<!-- Back to top -->
	<div class="btn-back-to-top" id="myBtn">
		<span class="symbol-btn-back-to-top">
			<i class="zmdi zmdi-chevron-up"></i>
		</span>
	</div>

<!--===============================================================================================-->	
	<script src="../vendor/jquery/jquery-3.2.1.min.js"></script>
<!--===============================================================================================-->
	<script src="../vendor/animsition/js/animsition.min.js"></script>
<!--===============================================================================================-->
	<script src="../vendor/bootstrap/js/popper.js"></script>
	<script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
<!--===============================================================================================-->
	<script src="../vendor/select2/select2.min.js"></script>
	<script>
		$(".js-select2").each(function(){
			$(this).select2({
				minimumResultsForSearch: 20,
				dropdownParent: $(this).next('.dropDownSelect2')
			});
		})
	</script>
<!--===============================================================================================-->
	<script src="../vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>
<!--===============================================================================================-->
	<script src="../vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
	<script>
		$('.js-pscroll').each(function(){
			$(this).css('position','relative');
			$(this).css('overflow','hidden');
			var ps = new PerfectScrollbar(this, {
				wheelSpeed: 1,
				scrollingThreshold: 1000,
				wheelPropagation: false,
			});

			$(window).on('resize', function(){
				ps.update();
			})
		});
	</script>
<!--===============================================================================================-->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAKFWBqlKAGCeS1rMVoaNlwyayu0e0YRes"></script>
	<script src="../js/map-custom.js"></script>
<!--===============================================================================================-->
	<script src="../js/main.js"></script>
<script src="/js/common.js"></script>
<!--===============================================================================================-->
<script>
	$(document).ready(function () {

		let auth = localStorage.getItem('accessToken');
		//로그인 안되어 있으면 로그인으로 옮기기
		if (!auth) {
			alert("로그인 후 이용해 주세요");
			window.location.href = "login.html";
		}
// 장바구니 아이콘 개수
		window.common.getShoppingCart()
		.done(function (response) {
			if (response) {
				let itemCount = response.cartItemDtoList.length;
				if (itemCount === 10) {
					itemCount = '10+';
				}
				$('a#cart-icon')[0].dataset.notify = itemCount;
			} else {
				$('a#cart-icon')[0].dataset.notify = '0';
			}
		})
		.fail(function (error) {
			console.log(error.message);
		});

// 찜 아이콘 개수
		window.common.getWishList()
		.done(function (response) {
			if (response) {
				let itemCount = response.length;
				if (itemCount === 10) {
					itemCount = '10+';
				}
				$('a#wish-icon')[0].dataset.notify = itemCount;
			} else {
				$('a#wish-icon')[0].dataset.notify = '0';
			}
		})
		.fail(function (error) {
			console.log(error.message);
		});
		fetchUserInfo()
	});
</script>

<script>
	// 사용자 정보 호출
	function fetchUserInfo() {
		$.ajax({
			type: 'GET',
			url: '/users',
			success: function(response) {
				updateUserInfo(response);
				console.log(response);
				fetchOrderInfo()
			},
			error: function(error) {
				console.error('Error fetching user info:', error);
			}
		});
	}

	// 주문 정보 호출
	function fetchOrderInfo() {
		$.ajax({
			type: 'GET',
			url: '/orders', // 주문 정보를 가져오는 API URL
			success: function(response) {
				updateOrderInfo(response);
			},
			error: function(error) {
				console.error('Error fetching order info:', error);
			}
		});
	}

	// 사용자 정보 업데이트
	function updateUserInfo(userResponseDto) {
		let gradeIcon = '';
		let gradeName = '';
		let currentMonthSpent = ''; // 현재 결제 금액
		let totalSpent = ''; // 총 결제 금액

		// 사용자 등급 아이콘 및 이름 설정
		switch (userResponseDto.grade) {
			case 'BRONZE':
				gradeIcon = '../images/icons/bronze.png';
				gradeName = '브론즈';
				break;
			case 'SILVER':
				gradeIcon = '../images/icons/silver.png';
				gradeName = '실버';
				break;
			case 'GOLD':
				gradeIcon = '../images/icons/gold.png';
				gradeName = '골드';
				break;
			default:
				gradeIcon = '../images/icons/bronze.png';
				gradeName = '브론즈';
		}

		// 등급 아이콘 및 이름 업데이트
		$('#grade-icon').attr('src', gradeIcon);
		$('#grade-name').text(gradeName);

		// 주문 정보를 가져온 후 결제 금액 업데이트
		fetchOrderInfo(); // 주문 정보를 다시 호출하여 결제 금액을 업데이트
	}

	// 주문 정보 업데이트
	function updateOrderInfo(orderResponseDtos) {
		let currentMonthSpent = 0; // 현재 결제 금액
		let totalSpent = 0; // 총 결제 금액

		// 현재 달 결제 금액 및 총 결제 금액 계산
		orderResponseDtos.forEach(function(order) {
			const orderDate = new Date(order.createdAt);
			const now = new Date();

			// 현재 달의 결제 금액 계산
			if (orderDate.getFullYear() === now.getFullYear() && orderDate.getMonth() === now.getMonth()) {
				currentMonthSpent += order.totalPrice;
			}

			// 총 결제 금액 계산
			totalSpent += order.totalPrice;
		});

		// 업데이트된 결제 금액을 UI에 반영
		$('#current-month-spent').text(`00월 결제금액: ${currentMonthSpent}원`);
		$('#total-spent').text(`총 결제금액: ${totalSpent}원`);

	// 다음 달 예상 등급 계산
	const currentGrade = $('#grade-name').text();
	const nextGrade = getNextGrade(currentGrade, currentMonthSpent);
	$('#next-month-grade').text(`다음 달 예상 등급: ${nextGrade}`);
	}

	// 다음 달 예상 등급 계산
	function getNextGrade(currentGrade, currentMonthSpent) {
		// 등급과 해당 기준 구매금액
		const gradeThresholds = {
			'브론즈': 100000, // 10만원
			'실버': 200000,   // 20만원
			'골드': Infinity   // 무한대, 최고 등급
		};

		// 다음 등급 기준
		const gradeOrder = ['브론즈', '실버', '골드', '최고'];

		// 현재 등급의 인덱스를 찾기
		const currentIndex = gradeOrder.indexOf(currentGrade);

		// 구매금액을 기반으로 다음 등급 계산
		for (let i = currentIndex + 1; i < gradeOrder.length; i++) {
			const grade = gradeOrder[i];
			if (currentMonthSpent > gradeThresholds[gradeOrder[i - 1]]) {
				return grade;
			}
		}
		return '브론즈'; // 기본 등급
	}
</script>

</body>
</html>